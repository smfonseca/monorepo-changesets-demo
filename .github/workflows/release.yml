# name: üöÄ Release

# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:

# permissions:
#   contents: write
#   id-token: write
#   pull-requests: write

# env:
#   GITHUB_TOKEN: ${{ secrets.CHANGESET_GH }}
#   # GITHUB_FREEZE: ${{ secrets.CODE_FREEZE }}
#   NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

# jobs:
#   release:
#     name: üöÄ Release
#     strategy:
#       matrix:
#         os: [ubuntu-latest]
#         node-version: [lts/*]
#         pnpm-version: [latest]
#     runs-on: ${{ matrix.os }}
#     steps:
#       - name: ‚¨áÔ∏è Checkout
#         id: checkout
#         uses: actions/checkout@v2.3.3
#         with:
#           token: ${{ env.GITHUB_TOKEN }}
#           fetch-depth: 0

#       - name: üü¢ Setup node
#         id: setup-node
#         uses: actions/setup-node@v2
#         with:
#           node-version: ${{ matrix.node-version }}

#       - name: ü•° Setup pnpm
#         id: setup-pnpm
#         uses: pnpm/action-setup@v2.1.0
#         with:
#           version: ${{ matrix.pnpm-version }}
#           run_install: false

#       - name: üéà Get pnpm store directory
#         id: get-pnpm-cache-dir
#         run: |
#           echo "::set-output name=pnpm_cache_dir::$(pnpm store path)"

#       - name: üß© Install Dependencies
#         id: install-dependencies
#         run: pnpm install

#       - name: Release
#         run: pnpm release

#       - name: Create Release Pull Request
#         uses: changesets/action@v1
#         env:
#           GITHUB_TOKEN: ${{ env.GITHUB_TOKEN }}

#       - name: Create Release Pull Request or Publish to npm
#         id: changesets
#         uses: changesets/action@v1
#         with:
#           publish: yarn release
#         env:
#           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#           NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

name: Release new main version

on:
  push:
    branches:
      - 'main'
      - 'next'
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

env:
  GITHUB_TOKEN: ${{ secrets.CHANGESET_GH }}

jobs:
  publish-main:
    name: Publish stable from main
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
            node-version: 22

      - name: Upgrade npm to latest
        run: npm i -g npm@latest

      - uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm i

      - name: Release
        run: node ./scripts/release.mjs

  publish-next:
    name: Publish prerelease from next
    if: github.ref == 'refs/heads/next'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Upgrade npm to v11+
        run: npm i -g npm@latest

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install

      - name: Release next
        run: node ./scripts/release-next.mjs
